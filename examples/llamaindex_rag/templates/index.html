<!DOCTYPE html>
<html lang="zh-CN">
<!-- Generated by AI -->

<head>
  <meta charset="UTF-8">
  <title>LlamaIndex & TiDB RAG Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://unpkg.com/marked@0.3.6"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>

<body>
  <div class="flex justify-center py-40">
    <div id="app" class="w-1/2">
      <label class="block">
        <input type="text" v-model="question" placeholder="Input question..."
          class="block p-2 w-full border-solid border-gray-300 focus:border-gray-900 border rounded-none focus:outline-none">
      </label>
      <button type="button" class="bg-black block w-full my-2 p-2 rounded	text-white" :disabled="loading"
        @click="askQuestion">
        <i v-if="loading && responses == ''" class="fas fa-spinner animate-spin"></i>
        Ask
      </button>
      <div id="responses" class="w-full min-h-full border py-2 px-6">
        <div v-html="compiledMarkdown">Empty</div>
      </div>
    </div>
  </div>
  <script>
    new Vue({
      el: '#app',
      data: {
        question: 'What did the author do at each stage of his/her growth? Use markdown format if possible',
        responses: 'Empty...',
        loading: false
      },
      computed: {
        compiledMarkdown: function () {
          return marked(this.responses, { sanitize: true });
        }
      },
      methods: {
        askQuestion: function () {
          const self = this;
          if (this.question.trim() === '') {
            alert('Please input a question.');
            return;
          }
          self.responses = '';
          self.loading = true;
          fetch(`/ask?q=${encodeURIComponent(this.question)}`)
            .then(response => {
              const reader = response.body.getReader();
              const stream = new ReadableStream({
                start(controller) {
                  function push() {
                    reader.read().then(({ done, value }) => {
                      if (done) {
                        controller.close();
                        self.loading = false;
                        return;
                      }
                      const chunk = new TextDecoder("utf-8").decode(value);
                      self.responses += chunk;
                      controller.enqueue(value);
                      push();
                    }).catch(error => {
                      self.loading = false;
                      console.error('Fetch error:', error);
                      controller.error(error);
                    });
                  }
                  push();
                }
              });
              return new Response(stream);
            })
            .catch(error => {
              console.error('Fetch error:', error);
              self.loading = false;
              alert('An error occurred while fetching the response.');
            });
        }
      }
    });
  </script>
</body>

</html>